<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta content="▀▄▀▄▀▄ art, music, code ▄▀▄▀▄▀" name="description"/>
    <meta content="art, music, code" name="keywords"/>
    <meta content="Brandon Stone" name="author"/>
    <meta content="🏡" property="og:title"/>
    <meta content="website" property="og:type"/>
    <meta content="https://brandonstone.cc/" property="og:url"/>
    <meta content="▀▄▀▄▀▄ art, music, code ▄▀▄▀▄▀" property="og:description"/>
    <title>this month</title>

    <link href="https://barndoors.cc/src/favicon/favicon.ico" rel="icon"/>
    <link rel="stylesheet" href="https://barndoors.cc/style.css" />
    <script src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js" type="module"></script>
    <script src="/currentlyreading.js"></script>
    <style>
        .day{padding:1rem;margin:1rem 0}
        .day h2{margin:0 0 .75rem;font-size:1.1rem;opacity:.85}
        .columns{display:grid;gap:1rem}
        @media (min-width: 780px){.columns{grid-template-columns:1fr 1fr}}
        .status-list{list-style:none;padding:0;margin:0;display:grid;gap:.5rem}
        .status{padding:.5rem .75rem;}
        .muted{opacity:.7;font-size:.9em}
        table{width:100%;border-collapse:collapse;table-layout:fixed}
        th,td{padding:.35rem .35rem;border-bottom:1px solid ;text-align:center;white-space:nowrap}
        th{opacity:.8}
        .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
        .status{display:grid;grid-template-columns:auto 1fr;gap:.5rem;align-items:start}
        .status img{width:40px;height:40px;object-fit:cover;}
        @media (max-width: 520px){ th,td{font-size:12px} }
        @media (max-width: 380px){ th,td{font-size:11px} }
    </style>
</head>
<body>
<div class="homenavcontainer">
    <header>
        <h1>
            <a class="headerlink" href="https://barndoors.cc">this month</a>
        </h1>
        <nav>
            <div class="navsection">
                <a href="https://barndoors.cc">continue</a>
                <a href="index.html">ramblings</a>
            </div>
        </nav>
    </header>
    <div class="currently-reading-container"></div>
</div>
<main class="wrap">

    <section id="notice" class="loading">Loading current month…</section>
    <section id="days"></section>
</main>

<script>
    (()=>{
        const TZ = 'America/Denver'; // your timezone
        const USER = 'barndoors';
        const ATOM_URL = 'https://status.cafe/users/' + USER + '.atom';
        const SC_URL = 'https://statbot.utopian-catch-0t.workers.dev/'; // place sc.txt next to this page

        const daysEl = document.getElementById('days');
        const noticeEl = document.getElementById('notice');

        // Helpers
        const fmtDate = d => new Intl.DateTimeFormat('en-US', {weekday:'short', month:'short', day:'numeric', timeZone: TZ}).format(d);
        const ymd = d => new Intl.DateTimeFormat('en-CA', {year:'numeric', month:'2-digit', day:'2-digit', timeZone: TZ}).format(d); // YYYY-MM-DD

        const now = new Date();
        // Get current date in the specified timezone
        const todayInTZ = ymd(now);
        const [currentYear, currentMonth] = todayInTZ.split('-').map(Number);
        const monthStart = new Date(currentYear, currentMonth - 1, 1);
        const monthEnd = new Date(currentYear, currentMonth, 0); // last day

        function parseAtom(xmlText){
            const parser = new DOMParser();
            const doc = parser.parseFromString(xmlText, 'application/xml');
            const entries = [...doc.querySelectorAll('entry')].map(e => {
                const dateStr = e.querySelector('updated, published')?.textContent || '';
                // Parse the ISO date string and interpret it in the specified timezone
                const when = new Date(dateStr);
                return {
                    title: e.querySelector('title')?.textContent?.trim() || '',
                    content: e.querySelector('content')?.textContent?.trim() || '',
                    when: when
                };
            }).filter(x => x.when.toString() !== 'Invalid Date');
            // group by local YYYY-MM-DD in TZ
            const map = {};
            for(const s of entries){
                const key = ymd(s.when);
                (map[key] ||= []).push(s);
            }
            return map;
        }

        function scToDailyMap(text){
            // Each line: "{event name} on {date} at {time}"
            // Example: "Morning stretches on Oct 6, 2025 at 8:24 AM"
            const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
            const map = {};
            const rx = /^(.+?)\s+on\s+([A-Za-z]{3,9}\s+\d{1,2},\s*\d{4})\s+at\s+(.+)$/i;

            for (const line of lines) {
                const m = line.match(rx);
                if (!m) continue;
                const name = m[1];
                const dateStr = m[2];
                const timeStr = m[3];
                const when = new Date(dateStr + ' ' + timeStr); // parsed in your local TZ
                if (isNaN(when)) continue;
                const key = ymd(when);
                (map[key] ||= []).push({ when, category: name });
            }
            return map;
        }

        function getAllDaysInMonth(){
            const days = [];
            const today = ymd(new Date());
            // Loop through each day of the month
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            for(let day = 1; day <= daysInMonth; day++){
                const d = new Date(currentYear, currentMonth - 1, day);
                const dayKey = ymd(d);
                if(dayKey <= today) {
                    days.push(dayKey);
                }
            }
            return days;
        }

        function withinCurrentMonth(key){
            const [Y,M,D] = key.split('-').map(Number);
            const d = new Date(Y, M-1, D);
            return d >= monthStart && d <= monthEnd;
        }

        function renderDay(key, statuses, entries){
            // Parse YYYY-MM-DD in local timezone to avoid off-by-one errors
            const [Y, M, D] = key.split('-').map(Number);
            const dateObj = new Date(Y, M - 1, D);
            const day = document.createElement('article');
            day.className = 'day';
            day.innerHTML = '<h2>' + fmtDate(dateObj) + '<span class="sr-only"> (' + key + ')</span></h2>';

            const columns = document.createElement('div');
            columns.className = 'columns';

            // Always render status section
            const statusBox = document.createElement('div');
            if(statuses && statuses.length){
                const ul = document.createElement('ul');
                ul.className = 'status-list';
                statuses.forEach(s => {
                    const li = document.createElement('li');
                    li.className = 'status status-with-avatar';
                    const time = new Intl.DateTimeFormat('en-US', {hour:'numeric', minute:'2-digit', timeZone: TZ}).format(s.when);
                    const img = createAvatarImg();
                    const body = document.createElement('div');
                    body.innerHTML = '<div class="muted">' + time + '</div><div>' + (s.content || s.title).replace(/</g,'&lt;') + '</div>';
                    li.appendChild(img);
                    li.appendChild(body);
                    ul.appendChild(li);
                });
                statusBox.appendChild(ul);
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'muted';
                placeholder.style.padding = '.5rem .75rem';
                placeholder.textContent = 'nothing to say today';
                statusBox.appendChild(placeholder);
            }
            columns.appendChild(statusBox);

            // Always render chronicling table
            const tableBox = document.createElement('div');
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            table.appendChild(thead);
            table.appendChild(tbody);

            // Always-show columns in fixed order
            const wanted = [
                'Morning Stretches',
                'Journal',
                'Music',
                'Workout'
            ];
            // Build header row in this exact order
            const emoji = {
                'Morning Stretches': '🌄',
                'Journal': '📖',
                'Music': '🎷',
                'Workout': '🏋🏾‍♂️'
            };
            const hr = document.createElement('tr');
            wanted.forEach(w => {
                const th = document.createElement('th');
                th.textContent = emoji[w] || w;
                th.title = w; // tooltip with full label
                th.setAttribute('aria-label', w);
                th.style.textAlign = 'center';
                hr.appendChild(th);
            });
            thead.appendChild(hr);

            // Normalize categories for matching
            const norm = s => (s||'').trim().toLowerCase();
            // Group earliest time per category (by display name)
            const byCat = Object.create(null);
            if(entries && entries.length){
                entries.sort((a,b)=>a.when-b.when).forEach(e => {
                    const k = norm(e.category);
                    // map to one of the wanted names if close match
                    for(const w of wanted){
                        if(k === norm(w)){
                            if(!byCat[w]) byCat[w] = new Date(e.when);
                            break;
                        }
                    }
                });
            }
            // Build single-row, no header
            const tr = document.createElement('tr');
            wanted.forEach(w => {
                const td = document.createElement('td');
                td.style.whiteSpace = 'nowrap';
                td.style.textAlign = 'center';
                if(byCat[w]){
                    const t = new Intl.DateTimeFormat('en-US', {hour:'numeric', minute:'2-digit', timeZone: TZ}).format(byCat[w]);
                    td.textContent = t;
                } else {
                    td.textContent = '✕';
                    td.className = 'muted';
                }
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
            tableBox.appendChild(table);
            columns.appendChild(tableBox);

            day.appendChild(columns);
            daysEl.appendChild(day);
        }

        function escapeHtml(s){return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')}

        function createAvatarImg(){
            const img = new Image();
            img.src = 'https://brandonstone.cc/src/navbaranddogs/junkdrawer_me.webp';
            img.alt = USER + ' avatar';
            img.decoding = 'async';
            img.referrerPolicy = 'no-referrer';
            img.width = 40; img.height = 40;
            return img;
        }

        async function load(){
            try {
                const [atomResp, scResp] = await Promise.all([
                    fetch(ATOM_URL, {headers:{'Accept':'application/atom+xml'}}),
                    fetch(SC_URL, {cache:'no-store'})
                ]);

                if(!atomResp.ok) throw new Error('Failed to fetch Atom feed');
                if(!scResp.ok) throw new Error('Failed to fetch sc.txt');

                const [atomText, scText] = await Promise.all([atomResp.text(), scResp.text()]);

                const atomMap = parseAtom(atomText);
                const entriesMap = scToDailyMap(scText);

                // Get all days in the current month
                const allDays = getAllDaysInMonth();

                // Sort descending (latest first)
                const ordered = allDays.sort((a,b)=> new Date(b) - new Date(a));

                daysEl.innerHTML = '';
                for(const k of ordered){
                    const statuses = atomMap[k] || [];
                    const entries = entriesMap[k] || [];
                    // Always render the day (chronicling table always shows)
                    renderDay(k, statuses, entries);
                }

                noticeEl.remove();
            } catch (err){
                noticeEl.className = 'error';
                noticeEl.textContent = err.message + ' — tip: if the Atom feed is blocked by CORS, proxy it server-side.';
            }
        }

        load();
    })();
</script>
</body>
</html>